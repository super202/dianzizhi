<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>ç”µå­çº¸æ§åˆ¶å™¨</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: sans-serif; margin: 20px; }
    .section { margin-bottom: 30px; }
    textarea { width: 100%; height: 150px; font-size: 16px; margin-bottom: 10px; }
    button { font-size: 16px; padding: 6px 12px; margin-right: 8px; cursor: pointer; }
    canvas { display: block; border: 1px solid #ccc; }
    #log {
      background: #eee;
      padding: 10px;
      height: 160px;
      overflow-y: auto;
      font-family: monospace;
      border: 1px solid #aaa;
      font-size: 14px;
    }
    .status-bar { font-size: 14px; color: #444; margin-top: 10px; }
    label { margin-right: 5px; }
    .flex-row { display: flex; gap: 20px; align-items: flex-start; flex-wrap: wrap; }
    .flex-grow { flex: 1; min-width: 250px; }
    .style-controls { margin-top: 10px; }
  </style>
</head>

<body>
  <h2>4.2 å¯¸ç”µå­å¢¨æ°´å±è“ç‰™æ§åˆ¶å™¨</h2>

  <div class="section flex-row">
    <fieldset class="flex-grow">
      <legend>ğŸ“‹ è¾“å…¥å¾…åŠäº‹é¡¹</legend>
      <textarea id="todoInput" placeholder="æ¯è¡Œä¸€ä¸ªäº‹é¡¹ï¼Œå¦‚ï¼š\nå¼€ä¼š 9 ç‚¹\næäº¤æ—¥æŠ¥"></textarea>

      <div class="style-controls">
        <label>æ ‡é¢˜å¤§å° <input type="number" id="titleSize" value="38" /></label>
        <label>æ—¥æœŸå¤§å° <input type="number" id="dateSize" value="18" /></label>
        <label>åˆ—è¡¨å¤§å° <input type="number" id="fontSize" value="20" /></label>
        <label>è¡Œé—´è· <input type="number" id="lineHeight" value="26" /></label>
        <label>å­—ä½“é¢œè‰² <input type="color" id="fontColor" value="#000000" /></label>
        <label>åº•éƒ¨å¤§å° <input type="number" id="footerSize" value="18" /></label>
      </div>

      <button onclick="generateAndSend()">ğŸ–¼ ä¸€é”®ç”Ÿæˆå¹¶å‘é€</button>
    </fieldset>
    <canvas id="canvas" width="400" height="300"></canvas>
  </div>

  <div class="section">
    <fieldset>
      <legend>è“ç‰™è¿æ¥</legend>
      <button id="connectbutton" onclick="preConnect()">è¿æ¥</button>
      <button id="reconnectbutton" onclick="reConnect()">é‡è¿</button>
      <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
      <button onclick="syncTime(1)">æ—¥å†æ¨¡å¼</button>
      <button onclick="syncTime(2)">æ—¶é’Ÿæ¨¡å¼</button>
      <button onclick="clearScreen()">æ¸…é™¤å±å¹•</button>
      <div id="log"></div>
    </fieldset>
  </div>

  <div class="section">
    <fieldset>
      <legend>è“ç‰™ä¼ å›¾</legend>
      <label for="image_file">é€‰æ‹©æ–‡ä»¶</label>
      <input type="file" id="image_file" onchange="update_image()" accept=".png,.jpg,.bmp,.webp,.jpeg" />

      <label for="dithering">å–æ¨¡ç®—æ³•</label>
      <select id="dithering" onchange="update_image()">
        <option value="bwr_floydsteinberg">ä¸‰è‰² Floyd</option>
        <option value="bwr_Atkinson" selected>ä¸‰è‰² Atkinson</option>
        <option value="floydsteinberg">é»‘ç™½ Floyd</option>
        <option value="none">é»‘ç™½ äºŒå€¼åŒ–</option>
      </select>

      <label for="threshold">é˜ˆå€¼</label>
      <input type="number" id="threshold" value="125" />

      <label for="mtusize">MTU</label>
      <input type="number" id="mtusize" value="20" />

      <label for="interleavedcount">ç¡®è®¤é—´éš”</label>
      <input type="number" id="interleavedcount" value="50" />

      <br /><br />
      <button onclick="clear_canvas()">æ¸…é™¤ç”»å¸ƒ</button>
      <button id="sendimgbutton" onclick="sendimg()">å‘é€å›¾ç‰‡</button>
      <div class="status-bar">çŠ¶æ€ï¼š<span id="status"></span></div>
    </fieldset>
  </div>

  <div style="display: none;">
    <input type="text" id="epdpins" value="" />
    <select id="epddriver"><option value="01" selected></option></select>
    <button id="sendcmdbutton"></button>
    <button id="calendarmodebutton"></button>
    <button id="clockmodebutton"></button>
    <button id="clearscreenbutton"></button>
    <button id="setDriverbutton"></button>
  </div>

  <img id="demo-img" style="display: none" src="" />
  
  <div>
      <div>
          ä¸€é”®ç”Ÿæˆé»˜è®¤å‚æ•°ä¸ºã€å–æ¨¡ç®—æ³•ï¼šä¸‰è‰² Atkinson----4.2å¯¸ä¸‰è‰²å±    ï¼ˆæˆ‘å°±æ˜¯ä¸ªå†™å‰ç«¯çš„å…¶ä»–ä¸å¤ªæ‡‚ï¼‰ã€‘
      </div>
      æœ€è¿‘æœ‰ç‚¹å¿™ï¼Œæºç åé¢æ•´ç†ä¸€ä¸‹æŒ‚ä¸Šæ¥
      <a href="https://tsl0922.github.io/EPD-nRF5/" target="_blank">æ„Ÿè°¢å¤§ä½¬å¼€æº</a>
      
  </div>

  <script src="js/dithering.js?v=20250511"></script>
  <script src="js/main.js?v=20250511"></script>

  <script>
    let yiText = "å®œï¼šæ¥å£å‡ºé”™ï¼Œæ— æ•°æ®";
    let jiText = "å¿Œï¼šæ¥å£å‡ºé”™ï¼Œæ— æ•°æ®";

    async function fetchAlmanac() {
      try {
        const res = await fetch("/hl.php");
        const json = await res.json();
        if (json.success && json.data) {
          yiText = "å®œï¼š" + json.data.yi;
          jiText = "å¿Œï¼š" + json.data.ji;
        }
      } catch (e) {
        console.warn("é»„å†æ¥å£è¯·æ±‚å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®", e);
      }
    }

    async function generateAndSend() {
      document.getElementById("dithering").value = "bwr_Atkinson";
      await fetchAlmanac();
      generateTodoImage();
      setTimeout(() => sendimg(), 100);
    }

    function generateTodoImage() {
      const canvas = document.getElementById("canvas");
      const ctx = canvas.getContext("2d", { willReadFrequently: true });
      const input = document.getElementById("todoInput").value;
      const lines = input.split("\n").filter(l => l.trim() !== "");

      const fontSize = parseInt(document.getElementById("fontSize").value) || 20;
      const lineHeight = parseInt(document.getElementById("lineHeight").value) || 26;
      const fontColor = document.getElementById("fontColor").value || "#000000";
      const titleSize = parseInt(document.getElementById("titleSize").value) || 38;
      const dateSize = parseInt(document.getElementById("dateSize").value) || 18;
      const footerSize = parseInt(document.getElementById("footerSize").value) || 18;

      ctx.fillStyle = "white";
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // çº¢è‰²æ ‡é¢˜æ èƒŒæ™¯
      ctx.fillStyle = "red";
      ctx.fillRect(0, 0, canvas.width, 50);

      // ä¸»æ ‡é¢˜ï¼šå­—é—´è·åŠ å¤§ + ä¸Šéƒ¨ç•™ç©º
      const title = "å¾…åŠäº‹é¡¹";
      ctx.fillStyle = "white";
      ctx.font = `bold ${titleSize}px sans-serif`;
      ctx.textAlign = "left";
      const spacing = 14;
      const charWidth = ctx.measureText("å¾…").width;
      const totalWidth = title.length * charWidth + (title.length - 1) * spacing;
      const startX = (canvas.width - totalWidth) / 2;
      const titleY = 35; // å‘ä¸‹ç§»ä¸€ç‚¹
      for (let i = 0; i < title.length; i++) {
        ctx.fillText(title[i], startX + i * (charWidth + spacing), titleY);
      }

      // æ—¥æœŸ & æ˜ŸæœŸ
      const now = new Date();
      const month = now.getMonth() + 1;
      const day = now.getDate();
      const week = ["æ˜ŸæœŸæ—¥", "æ˜ŸæœŸä¸€", "æ˜ŸæœŸäºŒ", "æ˜ŸæœŸä¸‰", "æ˜ŸæœŸå››", "æ˜ŸæœŸäº”", "æ˜ŸæœŸå…­"][now.getDay()];

      ctx.font = `bold ${dateSize}px sans-serif`;
      ctx.textAlign = "left";
      ctx.fillText(`${month}æœˆ${day}æ—¥`, 10, 48);
      ctx.textAlign = "right";
      ctx.fillText(week, canvas.width - 10, 48);

      // åˆ—è¡¨
      const startY = 80;
      ctx.font = `bold ${fontSize}px sans-serif`;
      ctx.textAlign = "left";

      lines.slice(0, 6).forEach((item, i) => {
        const x = 10;
        const y = startY + i * lineHeight;
        const label = `${i + 1}. ${item}`;
        ctx.fillStyle = fontColor;
        ctx.fillText(label, x, y);
        const textWidth = ctx.measureText(label).width;
        ctx.strokeStyle = "red";
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(x, y + 5);
        ctx.lineTo(x + textWidth, y + 5);
        ctx.stroke();
      });

      // åº•éƒ¨åˆ†å‰²çº¿
      const dividerY = canvas.height - 46;
      ctx.strokeStyle = "red";
      ctx.beginPath();
      ctx.moveTo(0, dividerY);
      ctx.lineTo(canvas.width, dividerY);
      ctx.stroke();

      // é»‘åº• + é»„å†
      ctx.fillStyle = "black";
      ctx.fillRect(0, canvas.height - 45, canvas.width, 45);
      ctx.font = `bold ${footerSize}px sans-serif`;
      ctx.textAlign = "left";
      ctx.fillStyle = "white";
      ctx.fillText(`ã€${yiText}ã€‘`, 10, canvas.height - 26);
      ctx.fillStyle = "red";
      ctx.fillText(`ã€${jiText}ã€‘`, 10, canvas.height - 8);

      convert_dithering();
    }
  </script>
</body>
</html>
